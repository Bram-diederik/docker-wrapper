#!/bin/bash
command=$@

# Forbidden mount paths (exact matches)
forbidden_paths=("/etc" "/" "/dev" "/proc" "/sys" "/boot" "/root" "/var/run/docker.sock")

# Function to resolve real paths, following symlinks
resolve_path() {
    local path="$1"
    
    # Use readlink to resolve symbolic (soft) links
    real_path=$(readlink -f "$path")
    
    if [[ -z "$real_path" ]]; then
        real_path="$path"  # If readlink fails, fallback to the original path
    fi
    
    echo "$real_path"
}

# Function to check for forbidden mount paths, including symlinks
check_mount_paths() {
    for path in "$@"; do
        real_path=$(resolve_path "$path")  # Resolve symlinks
        for forbidden in "${forbidden_paths[@]}"; do
            if [[ "$real_path" == "$forbidden" || "$real_path" == "$forbidden/"* ]]; then
                echo "Error: Attempting to mount forbidden path: $forbidden"
                exit 1
            fi
        done
    done
}

# Function to parse and check the compose YAML files
check_docker_compose_file() {
    local file="$1"
    
    # Extract all volume mount sources from the YAML file and check them
    local mounts=$(grep -Po '(?<=- )[^\s]+(?=:)' "$file")
    
    for mount in $mounts; do
        check_mount_paths "$mount"
    done
}

# Determine the YAML file(s) used by docker-compose
yaml_files=()
while [[ "$#" -gt 0 ]]; do
    case $1 in
        -f|--file)
            shift
            yaml_files+=("$1")
            ;;
    esac
    shift
done

# If no -f flag was passed, check files in order of preference:
if [[ ${#yaml_files[@]} -eq 0 ]]; then
    if [[ -f "compose.yaml" ]]; then
        yaml_files+=("compose.yaml")
    elif [[ -f "compose.yml" ]]; then
        yaml_files+=("compose.yml")
    elif [[ -f "docker-compose.yaml" ]]; then
        yaml_files+=("docker-compose.yaml")
    elif [[ -f "docker-compose.yml" ]]; then
        yaml_files+=("docker-compose.yml")
    else
        echo "Error: No compose file found in the current directory."
        exit 1
    fi
fi

# Check each compose file for forbidden mounts
for yaml_file in "${yaml_files[@]}"; do
    if [[ -f "$yaml_file" ]]; then
        check_docker_compose_file "$yaml_file"
    else
        echo "Error: Specified docker-compose file not found: $yaml_file"
        exit 1
    fi
done

# Execute the real docker-compose command
/usr/bin/docker-compose $command
