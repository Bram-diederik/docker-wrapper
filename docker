#!/bin/bash
command=$@

# Forbidden mount paths (exact matches)
forbidden_paths=("/etc" "/" "/dev" "/proc" "/sys" "/boot" "/root" "/var/run/docker.sock")

# Function to resolve real paths, following symlinks
resolve_path() {
    local path="$1"
    
    # Use readlink to resolve symbolic (soft) links
    real_path=$(readlink -f "$path")
    
    if [[ -z "$real_path" ]]; then
        real_path="$path"  # If readlink fails, fallback to the original path
    fi
    
    echo "$real_path"
}

# Function to check for forbidden mount paths, including symlinks
check_mount_paths() {
    for path in "$@"; do
        real_path=$(resolve_path "$path")  # Resolve symlinks
        for forbidden in "${forbidden_paths[@]}"; do
            if [[ "$real_path" == "$forbidden" || "$real_path" == "$forbidden/"* ]]; then
                echo "Error: Attempting to mount forbidden path: $forbidden"
                exit 1
            fi
        done
    done
}

# Check if docker run/exec is using -v/--volume option
if [[ "$1" == "run" || "$1" == "exec" ]]; then
    # Look for -v or --volume arguments
    while [[ "$#" -gt 0 ]]; do
        case $1 in
            -v|--volume)
                shift
                mount_source=$(echo "$1" | cut -d: -f1)
                check_mount_paths "$mount_source"
                ;;
        esac
        shift
    done
fi

# Execute the real docker command
/usr/bin/docker $command
